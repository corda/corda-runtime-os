{{- if or ( not .Values.bootstrap.db.crypto.password.valueFrom.secretKeyRef.name) ( not .Values.bootstrap.db.crypto.username.valueFrom.secretKeyRef.name) }}
{{- $name := include "corda.cryptoDbDefaultSecretName" . }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $name }}
  annotations:
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook": pre-install
  labels:
    {{- include "corda.labels" . | nindent 4 }}
type: Opaque
data:
{{- if (not .Values.bootstrap.db.crypto.password.valueFrom.secretKeyRef.name) }}
{{- if .Values.bootstrap.db.crypto.password.value }}
  password: {{ .Values.bootstrap.db.crypto.password.value | b64enc | quote }}
{{- else }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $name }}
{{- if $existingSecret }}
  password: {{ $existingSecret.data.password }}
{{- else }}
  password: {{ randAlphaNum 12 | b64enc | quote }}
{{- end }}
{{- end }}
{{- end }}
{{- if (not .Values.bootstrap.db.crypto.username.valueFrom.secretKeyRef.name) }}
  username: {{ required "Must specify bootstrap.db.crypto.username.valueFrom.secretKeyRef.name or bootstrap.db.crypto.username.value" .Values.bootstrap.db.crypto.username.value | b64enc | quote }}
{{- end }}
{{- end }}
