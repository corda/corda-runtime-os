---
# Source: corda/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: corda-rest-tls
  annotations:
    certificate/altNames: "corda-rest-worker.default,corda-rest-worker.default.svc"
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  tls.crt: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURpRENDQW5DZ0F3SUJBZ0lSQUpJS3ZJbWg0Vjc0bkt4NGk2ek1BNmN3RFFZSktvWklodmNOQVFFTEJRQXcKT2pFNE1EWUdBMVVFQXhNdlVrVlRWQ0JYYjNKclpYSWdVMlZzWmkxVGFXZHVaV1FnUTJWeWRHbG1hV05oZEdsdgpiaUJCZFhSb2IzSnBkSGt3SGhjTk1qTXdOekV5TURneE9ERXdXaGNOTWpRd056RXhNRGd4T0RFd1dqQWNNUm93CkdBWURWUVFERXhGamIzSmtZUzF5WlhOMExYZHZjbXRsY2pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVAKQURDQ0FRb0NnZ0VCQU1TKzlIT0xGdzF6a2RKNk5EdGRPcUIxZ3Nrd3B4djFHZ3ZXbDF4YTQ3RWg1M09xdUFPRgowcTAwSVRjUHdQakUyKzRXbTA3K2FFRHQzcUlIR2I2YnY0SXljeERLUnZzazhTbkZ3RmhzR2pDWEY0b3VIalhnCmNCeUcvbG9ZeU5nenZmcGEwemZzaUxlZ0l5WWVsdUY5VGxFdFJ5VzdoVVFUTDNTMnZSZ1EwekhXQVl0bVorWTQKMDZCNnpsL3RGbXpDa29MZ2trUTFqY0lxdFBEdDYyVExURStJVFRFS284WFZaS2I4VXFtYVd0N2xXYnVwN3hSNAphZHhyM2lQVVBmWS9DcjdZQjRhcmMwOFZRUFpuK0pIR1FVM294b0tqdlpoV084Qy9OWnlpaVVqbFZ4MnE2UGgxCmZvL0szZ3d2RFJVcFplY1JsTGZyL2dPS1pDYUkvZlJmcGw4Q0F3RUFBYU9CcGpDQm96QU9CZ05WSFE4QkFmOEUKQkFNQ0JhQXdIUVlEVlIwbEJCWXdGQVlJS3dZQkJRVUhBd0VHQ0NzR0FRVUZCd01DTUF3R0ExVWRFd0VCL3dRQwpNQUF3SHdZRFZSMGpCQmd3Rm9BVUJRbi9kT2JZL3M2eklLKzl1RmdIQnVHUlJlb3dRd1lEVlIwUkJEd3dPb0laClkyOXlaR0V0Y21WemRDMTNiM0pyWlhJdVpHVm1ZWFZzZElJZFkyOXlaR0V0Y21WemRDMTNiM0pyWlhJdVpHVm0KWVhWc2RDNXpkbU13RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUU4dlcyS3I2L1FhK01xcGVpcXovRlJZcXlYego5ZUhGdG8xZU9saUo3NTQ4WDk2S2d1endrTXk5QnIyRWJ2ZXE4N0c1dFNkcnpDSzBGamo2ZHJFZi8yc2FYdTJGCnBXYk9xQ1Y5Ym8vUEdISWRGR2U3blIyY0daakpDNTBuTTZKV1dvSGhyVXFvamd6bTk4TnV4ZWFTWmpGbUFXKzUKT0J1N3Vva05SZXRSYXRORGlnU1VkY1ZpVHZmU3lHYjM1M1ZLMVlRVlJ6OXB5VHU3eDcxUG1qL25reFpxQXhQWgpnWTd1YXB1UXZyZVhtSFlnUDBSQ2JUSzN4REhwUlhTTUExb0MxU0hIT0IyMFhJcjhyWlVvVzM2MHRCTU5kTHlHCkJrYmJKSFVpSUh1a2dWaFFLUktzVUIvRjdJS1hRUjA1Z3NYSERJY1l3ZDZTVlVEK1lOcElBK2FNT0xFPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="
  tls.key: "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBeEw3MGM0c1hEWE9SMG5vME8xMDZvSFdDeVRDbkcvVWFDOWFYWEZyanNTSG5jNnE0CkE0WFNyVFFoTncvQStNVGI3aGFiVHY1b1FPM2VvZ2NadnB1L2dqSnpFTXBHK3lUeEtjWEFXR3dhTUpjWGlpNGUKTmVCd0hJYitXaGpJMkRPOStsclROK3lJdDZBakpoNlc0WDFPVVMxSEpidUZSQk12ZExhOUdCRFRNZFlCaTJabgo1ampUb0hyT1grMFdiTUtTZ3VDU1JEV053aXEwOE8zclpNdE1UNGhOTVFxanhkVmtwdnhTcVpwYTN1Vlp1Nm52CkZIaHAzR3ZlSTlROTlqOEt2dGdIaHF0elR4VkE5bWY0a2NaQlRlakdncU85bUZZN3dMODFuS0tKU09WWEhhcm8KK0hWK2o4cmVEQzhORlNsbDV4R1V0K3YrQTRwa0pvajk5RittWHdJREFRQUJBb0lCQUJtVDJhUEx5VXR1WXQ3QwpGRmhEWG9QTnd4cjB3RVRhTUhDcGpUUHNmUDFpTXZ6T2pPMm9VQ05FUzYwazF5bUFMamRkcVFNei84bXhJdWhkCmsvTTd2RUhvM1J5cHIyQ25CTk14YWpnVWxiTUxjWHY5VXVBZU5YVC85OEV1eDYyVHpIYm5wOTMxV2pERkdNeXoKM1Ztak9MTkU5NkxvSmdNYm0yZkkrZnhPODZYZXVpUmNKL2EzZ0EvblcxRExBc3ZvSVY1NGFxUStqcXQ4TzBnQQpENTVLbUFGV0dUNkFrTUs4UnBTaHFDT0NaN1g2bzE1a3FXQUR5MG45VUYyY0pwaFgzV0J4aFJkNlVBamt2d2o2CmplelIydnIrS3VLOU5COTBiYndkR2RqM255elFoUjY3bG5Ua3J6Rk5zWXNrbnYxbjdsZ3diaGN0ZHNNTmhpTloKK1ZhV3FrRUNnWUVBNXR5K2lvaE5wVUVxNCt4RjdSUXdoTGMyU2wwU2RIZERYVFhqUUZEaHV0bk11bERsYURoTApzWVdCRVY5ckJFMWZ5MG9TNjVUUEV4UjVoeEtJeklQREo4NDlrNExIbkg5eElVNnhoRWNyR3k2WDVCVGRpV2JJCkZOL0N5YURiNlBpdUhGYkRjY2wxYjhNVVNLajZVL25LcFBDS3lqc1FmcG5RMy9Xc1V4MkEyYVVDZ1lFQTJpczQKcm1oRlc5STZxb0hpcXJOWU5JbS9wQkVxdEFoNURDQWpyY1Y3eElxenpkNm1HSmxueEdrYk02eHNEbkc0dDBiTgpXSE44eFM0V2tPa0VLbWJBZGtma2tCdnlDVEdTR1A0elBmeEFEWFZWL3dHYVA5VCtmZURtbStCVU5BTFM3MUpNCi9RN3ZsdW1tMzZOdy9rWXdmU3hvVUtFTUhaQ0paOHpjeEUxZ0dMTUNnWUFPTGJhQ0daYnpORXBuRHliSVJib3AKSEh0NEc3azdiK3V5T05JSkxDNkE1RWwvaytKVEFVb2N6Lzg2U3VydXE3WGJiV1EyRmNDV0FtYm9WY29URFhDWgo3RCs1NUlsUDRqL1hkTmJRTWZMQ3k1ekdoRVdLMzhZZ0NoSVRnZzZmZzA1bUxTbjV2ZzY1VzNqT2NacFdOL3dyCkh4N1hCc09ma3VEU01HdHgrMWpqaFFLQmdFaGF3ejZjV0R4ZW1aUkk1VXFsbGlBK2V1OUh2ampkQW9BeC9JTTYKRnBVVlJ4S0V2K015cFVadmNWVU8zdnRmWGRweXdkR080NWRsZEpoMG55d016ZEdzZ0RJSEFwdG45RU1Uc3h6Zwpsc0dmNDNoaUtLejR6N29ocDNtVXlYaENZNEI1ZEEwTk1ncUR6Uk1vV21ZS0V6VEFVSXhGRFFhVkUrejM5Vk9wCk1iQ2ZBb0dCQU5pRzc4RmJta2pKMzdmOXBLSzN5TnBWWEVlRUFoZXI2Sy94Rllsb0ZaYjlWRHJFWXQyeHdQcE8KWDllVmhZLy9rTlFzL1VmbGtXOHlnWXhFSUVNM1ZTSkpUbXdEMkhhS1J0QjhobVNZZzJReVJIMGdNYmUrUlV1dQp5SFRFcHd0NUdjczJ1M3UvWHU1cFFIMm82VElXN28ybEZqYy9sRjc4VWRmRjc1MWg0eUs1Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg=="
  ca.crt: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURZRENDQWtpZ0F3SUJBZ0lSQUpCdE10RjhFWWd0USt1dlN6TUc2MTR3RFFZSktvWklodmNOQVFFTEJRQXcKT2pFNE1EWUdBMVVFQXhNdlVrVlRWQ0JYYjNKclpYSWdVMlZzWmkxVGFXZHVaV1FnUTJWeWRHbG1hV05oZEdsdgpiaUJCZFhSb2IzSnBkSGt3SGhjTk1qTXdOekV5TURneE9ERXdXaGNOTWpZd05EQTNNRGd4T0RFd1dqQTZNVGd3Ck5nWURWUVFERXk5U1JWTlVJRmR2Y210bGNpQlRaV3htTFZOcFoyNWxaQ0JEWlhKMGFXWnBZMkYwYVc5dUlFRjEKZEdodmNtbDBlVENDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFMaUJYZytaRC9KbgpNTTBrME1jOU90KzQxVzhYUzBoN2NaMWJnR1Q1MXh6d1dlOXZrREFINUFhQTh6RnQ4bUlXc09YRTltTUtlc0IwCjM3bnhBMnN5ODdlSWNVZkg1TUdZR2FFMUxSejRldk8xdjZjVnRzaVJCeW5SNmxXdllCZEFlRWVseGZYRldiT08KdUs5QXpFZjI0NTEwSnJ3bkF4S09FSkRSaEtCcU95TkJRVnIrMFgvNVFOK3BQUnkzRDV6MUJnSC9JaW1BUXROMApaZ1Zqd25HVHBVRXNhZnMzMG5kdER4YkF6MnZNUzFoRDhCTVJOcGVEcTVyYklJdlZWczdLUDNNcVBmYkQrYmtuClNyVS9VWGYwa1ZPV0hKMDJuM0l5blhGcWhOVXhrRHFtcWNSUUVjL3ZaVjZHNVpEUzhKT1NpQmo4dDNrQldJUS8KKyt4ZjBHUU1yZDhDQXdFQUFhTmhNRjh3RGdZRFZSMFBBUUgvQkFRREFnS2tNQjBHQTFVZEpRUVdNQlFHQ0NzRwpBUVVGQndNQkJnZ3JCZ0VGQlFjREFqQVBCZ05WSFJNQkFmOEVCVEFEQVFIL01CMEdBMVVkRGdRV0JCUUZDZjkwCjV0ait6ck1ncjcyNFdBY0c0WkZGNmpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQVRlUEowMlR4aENMQVpmRDkKM3VmeGVmWVRWcWFmcFRmZ2NCNEJJUEdVTkxqM2V3b3NsTTZLYlI4Rk1mekpieEMwVHB5NWJOQUl3VjVTejZMSgo2ak5oUkV0a0Fjd0JSRkl6TXBEMlUvMzBaaUNsck5YZHVGbm1oK2V3Si9kcGV5MVdmN3JzeDVuWDRnc2UvekxPCnhHc2QzMWROS1liSU9TajFUbS9aOGdmZ1lSMXRQSE1mMHpJMzJaR2RhaGNPTHFuZ0lPai9BMXo0Vlk4YVpMNVoKMkFMQ2ZLZ1kvdngybFZlSnY0dVBWQzZUREFnK1loZlFGUU9YQzZPQkk3aGRtdG1XMDhSYVlnUjNiMnU2clZmZApFL2JoanRVYjFsSWJLNjhIam5jS1g3MVhLNjZPT2FLS1JGR3hMOWk3WWExUkZxM2JyMmhSNnVsZnJBbDQvUXhYCmhyZjhOQT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
---
# Source: corda/templates/workers.yaml
apiVersion: v1
kind: Service
metadata:
  name: "corda-p2p-gateway-worker"
  labels:
    
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: p2pGateway-worker
spec:
  type: 
  selector:
    
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/component: p2pGateway-worker
  ports:
  - name: http
    port: 8080
    targetPort: http
---
# Source: corda/templates/workers.yaml
apiVersion: v1
kind: Service
metadata:
  name: "corda-rest-worker"
  labels:
    
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: rest-worker
spec:
  type: ClusterIP
  selector:
    
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/component: rest-worker
  ports:
  - name: http
    port: 443
    targetPort: http
---
# Source: corda/templates/workers.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "corda-crypto-worker"
  labels:
    
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: crypto-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      
      app.kubernetes.io/name: corda
      app.kubernetes.io/instance: corda
      app.kubernetes.io/component: crypto-worker
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: /metrics
        prometheus.io/port: "7000"
      labels:
        
        app.kubernetes.io/name: corda
        app.kubernetes.io/instance: corda
        app.kubernetes.io/component: crypto-worker
    spec:
      securityContext:
        runAsUser: 10001
        runAsGroup: 10002
        fsGroup: 1000
      
            
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - crypto-worker
              topologyKey: kubernetes.io/hostname
            weight: 1
      containers:
      - name: "corda-crypto-worker"
        image: "corda-os-docker-dev.software.r3.com/corda-os-crypto-worker:latest-local-5.1.0"
        imagePullPolicy:  IfNotPresent
        
        securityContext:
          runAsUser: 10001
          runAsGroup: 10002
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - "ALL"
        resources:
          requests:
          limits:
        env:
          - name: K8S_NODE_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: spec.nodeName
          - name: K8S_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: K8S_POD_UID
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.uid
          - name: K8S_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: JAVA_TOOL_OPTIONS
            value:
              -XX:MaxRAMPercentage=75
          - name: LOG4J_CONFIG_FILE
            value: "/etc/log4j/log4j2.xml"
          - name: CONSOLE_LOG_FORMAT
            value: "text"
          - name: CONSOLE_LOG_LEVEL
            value: "info"
          - name: SASL_USERNAME
            value: admin
          - name: SASL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: "prereqs-kafka"
                key: "admin-password"
          - name: SALT
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "salt"
          - name: PASSPHRASE
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "passphrase"
          - name: DB_CLUSTER_USERNAME
            valueFrom:
              secretKeyRef:
                name: "corda-cluster-db"
                key: "username"
          - name: DB_CLUSTER_PASSWORD
            valueFrom:
              secretKeyRef:
                name: "prereqs-postgres"
                key: "corda-password"
        args:
          - "--workspace-dir=/work"
          - "--temp-dir=/tmp"
          - "-mbootstrap.servers=prereqs-kafka:9092"
          - "-msasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"$(SASL_USERNAME)\" password=\"$(SASL_PASSWORD)\";"
          - "--topic-prefix="
          - "-msecurity.protocol=SASL_SSL"
          - "-msasl.mechanism=PLAIN"
          - "-mssl.truststore.location=/certs/ca.crt"
          - "-mssl.truststore.type=PEM"
          - "-spassphrase=$(PASSPHRASE)"
          - "-ssalt=$(SALT)"
          - "-ddatabase.user=$(DB_CLUSTER_USERNAME)"
          - "-ddatabase.pass=$(DB_CLUSTER_PASSWORD)"
          - "-ddatabase.jdbc.url=jdbc:postgresql://prereqs-postgres:5432/cordacluster?currentSchema=CONFIG"
          - "-ddatabase.jdbc.directory=/opt/jdbc-driver"
          - "-ddatabase.pool.max_size=5"
          - "-ddatabase.pool.idleTimeoutSeconds=120"
          - "-ddatabase.pool.maxLifetimeSeconds=1800"
          - "-ddatabase.pool.keepaliveTimeSeconds=0"
          - "-ddatabase.pool.validationTimeoutSeconds=5"
          - "--trace-samples-per-second=1"
          - "--hsm-id=SOFT"
        volumeMounts:
          - mountPath: "/tmp"
            name: "tmp"
            readOnly: false
          - mountPath: "/work"
            name: "work"
            readOnly: false
          - mountPath: "/certs"
            name: "certs"
            readOnly: true
          - name: log4j
            mountPath: /etc/log4j
        ports:
          - name: monitor
            containerPort: 7000
        readinessProbe:
          httpGet:
            path: /status
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        livenessProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        startupProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 5
          failureThreshold: 20
          timeoutSeconds: 5
      volumes:
        - name: tmp
          emptyDir: {}
        - name: work
          emptyDir: {}
        - name: certs
          secret:
            secretName: "prereqs-kafka"
            items:
              - key: "ca.crt"
                path: "ca.crt"
        - name: log4j
          configMap:
            name: corda-log4j
---
# Source: corda/templates/workers.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "corda-db-worker"
  labels:
    
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: db-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      
      app.kubernetes.io/name: corda
      app.kubernetes.io/instance: corda
      app.kubernetes.io/component: db-worker
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: /metrics
        prometheus.io/port: "7000"
      labels:
        
        app.kubernetes.io/name: corda
        app.kubernetes.io/instance: corda
        app.kubernetes.io/component: db-worker
    spec:
      securityContext:
        runAsUser: 10001
        runAsGroup: 10002
        fsGroup: 1000
      
            
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - crypto-worker
              topologyKey: kubernetes.io/hostname
            weight: 1
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - db-worker
              topologyKey: kubernetes.io/hostname
            weight: 2
      containers:
      - name: "corda-db-worker"
        image: "corda-os-docker-dev.software.r3.com/corda-os-db-worker:latest-local-5.1.0"
        imagePullPolicy:  IfNotPresent
        
        securityContext:
          runAsUser: 10001
          runAsGroup: 10002
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - "ALL"
        resources:
          requests:
          limits:
        env:
          - name: K8S_NODE_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: spec.nodeName
          - name: K8S_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: K8S_POD_UID
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.uid
          - name: K8S_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: JAVA_TOOL_OPTIONS
            value:
              -XX:MaxRAMPercentage=75
          - name: LOG4J_CONFIG_FILE
            value: "/etc/log4j/log4j2.xml"
          - name: CONSOLE_LOG_FORMAT
            value: "text"
          - name: CONSOLE_LOG_LEVEL
            value: "info"
          - name: SASL_USERNAME
            value: admin
          - name: SASL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: "prereqs-kafka"
                key: "admin-password"
          - name: SALT
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "salt"
          - name: PASSPHRASE
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "passphrase"
          - name: DB_CLUSTER_USERNAME
            valueFrom:
              secretKeyRef:
                name: "corda-cluster-db"
                key: "username"
          - name: DB_CLUSTER_PASSWORD
            valueFrom:
              secretKeyRef:
                name: "prereqs-postgres"
                key: "corda-password"
        args:
          - "--workspace-dir=/work"
          - "--temp-dir=/tmp"
          - "-mbootstrap.servers=prereqs-kafka:9092"
          - "-msasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"$(SASL_USERNAME)\" password=\"$(SASL_PASSWORD)\";"
          - "--topic-prefix="
          - "-msecurity.protocol=SASL_SSL"
          - "-msasl.mechanism=PLAIN"
          - "-mssl.truststore.location=/certs/ca.crt"
          - "-mssl.truststore.type=PEM"
          - "-spassphrase=$(PASSPHRASE)"
          - "-ssalt=$(SALT)"
          - "-ddatabase.user=$(DB_CLUSTER_USERNAME)"
          - "-ddatabase.pass=$(DB_CLUSTER_PASSWORD)"
          - "-ddatabase.jdbc.url=jdbc:postgresql://prereqs-postgres:5432/cordacluster?currentSchema=CONFIG"
          - "-ddatabase.jdbc.directory=/opt/jdbc-driver"
          - "-ddatabase.pool.max_size=5"
          - "-ddatabase.pool.idleTimeoutSeconds=120"
          - "-ddatabase.pool.maxLifetimeSeconds=1800"
          - "-ddatabase.pool.keepaliveTimeSeconds=0"
          - "-ddatabase.pool.validationTimeoutSeconds=5"
          - "--trace-samples-per-second=1"
        volumeMounts:
          - mountPath: "/tmp"
            name: "tmp"
            readOnly: false
          - mountPath: "/work"
            name: "work"
            readOnly: false
          - mountPath: "/certs"
            name: "certs"
            readOnly: true
          - name: log4j
            mountPath: /etc/log4j
        ports:
          - name: monitor
            containerPort: 7000
        readinessProbe:
          httpGet:
            path: /status
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        livenessProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        startupProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 5
          failureThreshold: 20
          timeoutSeconds: 5
      volumes:
        - name: tmp
          emptyDir: {}
        - name: work
          emptyDir: {}
        - name: certs
          secret:
            secretName: "prereqs-kafka"
            items:
              - key: "ca.crt"
                path: "ca.crt"
        - name: log4j
          configMap:
            name: corda-log4j
---
# Source: corda/templates/workers.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "corda-flow-worker"
  labels:
    
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: flow-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      
      app.kubernetes.io/name: corda
      app.kubernetes.io/instance: corda
      app.kubernetes.io/component: flow-worker
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: /metrics
        prometheus.io/port: "7000"
      labels:
        
        app.kubernetes.io/name: corda
        app.kubernetes.io/instance: corda
        app.kubernetes.io/component: flow-worker
    spec:
      securityContext:
        runAsUser: 10001
        runAsGroup: 10002
        fsGroup: 1000
      
            
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - crypto-worker
              topologyKey: kubernetes.io/hostname
            weight: 1
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - db-worker
              topologyKey: kubernetes.io/hostname
            weight: 2
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - flow-worker
              topologyKey: kubernetes.io/hostname
            weight: 3
      containers:
      - name: "corda-flow-worker"
        image: "corda-os-docker-dev.software.r3.com/corda-os-flow-worker:latest-local-5.1.0"
        imagePullPolicy:  IfNotPresent
        
        securityContext:
          runAsUser: 10001
          runAsGroup: 10002
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - "ALL"
        resources:
          requests:
          limits:
        env:
          - name: K8S_NODE_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: spec.nodeName
          - name: K8S_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: K8S_POD_UID
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.uid
          - name: K8S_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: JAVA_TOOL_OPTIONS
            value:
              -XX:MaxRAMPercentage=75
          - name: LOG4J_CONFIG_FILE
            value: "/etc/log4j/log4j2.xml"
          - name: CONSOLE_LOG_FORMAT
            value: "text"
          - name: CONSOLE_LOG_LEVEL
            value: "info"
          - name: SASL_USERNAME
            value: admin
          - name: SASL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: "prereqs-kafka"
                key: "admin-password"
          - name: SALT
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "salt"
          - name: PASSPHRASE
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "passphrase"
        args:
          - "--workspace-dir=/work"
          - "--temp-dir=/tmp"
          - "-mbootstrap.servers=prereqs-kafka:9092"
          - "-msasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"$(SASL_USERNAME)\" password=\"$(SASL_PASSWORD)\";"
          - "--topic-prefix="
          - "-msecurity.protocol=SASL_SSL"
          - "-msasl.mechanism=PLAIN"
          - "-mssl.truststore.location=/certs/ca.crt"
          - "-mssl.truststore.type=PEM"
          - "-spassphrase=$(PASSPHRASE)"
          - "-ssalt=$(SALT)"
          - "--trace-samples-per-second=1"
        volumeMounts:
          - mountPath: "/tmp"
            name: "tmp"
            readOnly: false
          - mountPath: "/work"
            name: "work"
            readOnly: false
          - mountPath: "/certs"
            name: "certs"
            readOnly: true
          - name: log4j
            mountPath: /etc/log4j
        ports:
          - name: monitor
            containerPort: 7000
        readinessProbe:
          httpGet:
            path: /status
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        livenessProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        startupProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 5
          failureThreshold: 20
          timeoutSeconds: 5
      volumes:
        - name: tmp
          emptyDir: {}
        - name: work
          emptyDir: {}
        - name: certs
          secret:
            secretName: "prereqs-kafka"
            items:
              - key: "ca.crt"
                path: "ca.crt"
        - name: log4j
          configMap:
            name: corda-log4j
---
# Source: corda/templates/workers.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "corda-membership-worker"
  labels:
    
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: membership-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      
      app.kubernetes.io/name: corda
      app.kubernetes.io/instance: corda
      app.kubernetes.io/component: membership-worker
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: /metrics
        prometheus.io/port: "7000"
      labels:
        
        app.kubernetes.io/name: corda
        app.kubernetes.io/instance: corda
        app.kubernetes.io/component: membership-worker
    spec:
      securityContext:
        runAsUser: 10001
        runAsGroup: 10002
        fsGroup: 1000
      
            
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - crypto-worker
              topologyKey: kubernetes.io/hostname
            weight: 1
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - db-worker
              topologyKey: kubernetes.io/hostname
            weight: 2
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - flow-worker
              topologyKey: kubernetes.io/hostname
            weight: 3
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - membership-worker
              topologyKey: kubernetes.io/hostname
            weight: 4
      containers:
      - name: "corda-membership-worker"
        image: "corda-os-docker-dev.software.r3.com/corda-os-member-worker:latest-local-5.1.0"
        imagePullPolicy:  IfNotPresent
        
        securityContext:
          runAsUser: 10001
          runAsGroup: 10002
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - "ALL"
        resources:
          requests:
          limits:
        env:
          - name: K8S_NODE_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: spec.nodeName
          - name: K8S_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: K8S_POD_UID
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.uid
          - name: K8S_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: JAVA_TOOL_OPTIONS
            value:
              -XX:MaxRAMPercentage=75
          - name: LOG4J_CONFIG_FILE
            value: "/etc/log4j/log4j2.xml"
          - name: CONSOLE_LOG_FORMAT
            value: "text"
          - name: CONSOLE_LOG_LEVEL
            value: "info"
          - name: SASL_USERNAME
            value: admin
          - name: SASL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: "prereqs-kafka"
                key: "admin-password"
          - name: SALT
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "salt"
          - name: PASSPHRASE
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "passphrase"
        args:
          - "--workspace-dir=/work"
          - "--temp-dir=/tmp"
          - "-mbootstrap.servers=prereqs-kafka:9092"
          - "-msasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"$(SASL_USERNAME)\" password=\"$(SASL_PASSWORD)\";"
          - "--topic-prefix="
          - "-msecurity.protocol=SASL_SSL"
          - "-msasl.mechanism=PLAIN"
          - "-mssl.truststore.location=/certs/ca.crt"
          - "-mssl.truststore.type=PEM"
          - "-spassphrase=$(PASSPHRASE)"
          - "-ssalt=$(SALT)"
          - "--trace-samples-per-second=1"
        volumeMounts:
          - mountPath: "/tmp"
            name: "tmp"
            readOnly: false
          - mountPath: "/work"
            name: "work"
            readOnly: false
          - mountPath: "/certs"
            name: "certs"
            readOnly: true
          - name: log4j
            mountPath: /etc/log4j
        ports:
          - name: monitor
            containerPort: 7000
        readinessProbe:
          httpGet:
            path: /status
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        livenessProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        startupProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 5
          failureThreshold: 20
          timeoutSeconds: 5
      volumes:
        - name: tmp
          emptyDir: {}
        - name: work
          emptyDir: {}
        - name: certs
          secret:
            secretName: "prereqs-kafka"
            items:
              - key: "ca.crt"
                path: "ca.crt"
        - name: log4j
          configMap:
            name: corda-log4j
---
# Source: corda/templates/workers.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "corda-p2p-gateway-worker"
  labels:
    
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: p2pGateway-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      
      app.kubernetes.io/name: corda
      app.kubernetes.io/instance: corda
      app.kubernetes.io/component: p2pGateway-worker
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: /metrics
        prometheus.io/port: "7000"
      labels:
        
        app.kubernetes.io/name: corda
        app.kubernetes.io/instance: corda
        app.kubernetes.io/component: p2pGateway-worker
    spec:
      securityContext:
        runAsUser: 10001
        runAsGroup: 10002
        fsGroup: 1000
      
            
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - crypto-worker
              topologyKey: kubernetes.io/hostname
            weight: 1
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - db-worker
              topologyKey: kubernetes.io/hostname
            weight: 2
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - flow-worker
              topologyKey: kubernetes.io/hostname
            weight: 3
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - membership-worker
              topologyKey: kubernetes.io/hostname
            weight: 4
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - p2pGateway-worker
              topologyKey: kubernetes.io/hostname
            weight: 5
      containers:
      - name: "corda-p2p-gateway-worker"
        image: "corda-os-docker-dev.software.r3.com/corda-os-p2p-gateway-worker:latest-local-5.1.0"
        imagePullPolicy:  IfNotPresent
        
        securityContext:
          runAsUser: 10001
          runAsGroup: 10002
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - "ALL"
        resources:
          requests:
          limits:
        env:
          - name: K8S_NODE_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: spec.nodeName
          - name: K8S_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: K8S_POD_UID
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.uid
          - name: K8S_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: JAVA_TOOL_OPTIONS
            value:
              -XX:MaxRAMPercentage=75
          - name: LOG4J_CONFIG_FILE
            value: "/etc/log4j/log4j2.xml"
          - name: CONSOLE_LOG_FORMAT
            value: "text"
          - name: CONSOLE_LOG_LEVEL
            value: "info"
          - name: SASL_USERNAME
            value: admin
          - name: SASL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: "prereqs-kafka"
                key: "admin-password"
          - name: SALT
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "salt"
          - name: PASSPHRASE
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "passphrase"
        args:
          - "--workspace-dir=/work"
          - "--temp-dir=/tmp"
          - "-mbootstrap.servers=prereqs-kafka:9092"
          - "-msasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"$(SASL_USERNAME)\" password=\"$(SASL_PASSWORD)\";"
          - "--topic-prefix="
          - "-msecurity.protocol=SASL_SSL"
          - "-msasl.mechanism=PLAIN"
          - "-mssl.truststore.location=/certs/ca.crt"
          - "-mssl.truststore.type=PEM"
          - "-spassphrase=$(PASSPHRASE)"
          - "-ssalt=$(SALT)"
          - "--trace-samples-per-second=1"
        volumeMounts:
          - mountPath: "/tmp"
            name: "tmp"
            readOnly: false
          - mountPath: "/work"
            name: "work"
            readOnly: false
          - mountPath: "/certs"
            name: "certs"
            readOnly: true
          - name: log4j
            mountPath: /etc/log4j
        ports:
          - name: http
            containerPort: 8080
          - name: monitor
            containerPort: 7000
        readinessProbe:
          httpGet:
            path: /status
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        livenessProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        startupProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 5
          failureThreshold: 20
          timeoutSeconds: 5
      volumes:
        - name: tmp
          emptyDir: {}
        - name: work
          emptyDir: {}
        - name: certs
          secret:
            secretName: "prereqs-kafka"
            items:
              - key: "ca.crt"
                path: "ca.crt"
        - name: log4j
          configMap:
            name: corda-log4j
---
# Source: corda/templates/workers.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "corda-p2p-link-manager-worker"
  labels:
    
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: p2pLinkManager-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      
      app.kubernetes.io/name: corda
      app.kubernetes.io/instance: corda
      app.kubernetes.io/component: p2pLinkManager-worker
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: /metrics
        prometheus.io/port: "7000"
      labels:
        
        app.kubernetes.io/name: corda
        app.kubernetes.io/instance: corda
        app.kubernetes.io/component: p2pLinkManager-worker
    spec:
      securityContext:
        runAsUser: 10001
        runAsGroup: 10002
        fsGroup: 1000
      
            
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - crypto-worker
              topologyKey: kubernetes.io/hostname
            weight: 1
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - db-worker
              topologyKey: kubernetes.io/hostname
            weight: 2
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - flow-worker
              topologyKey: kubernetes.io/hostname
            weight: 3
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - membership-worker
              topologyKey: kubernetes.io/hostname
            weight: 4
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - p2pGateway-worker
              topologyKey: kubernetes.io/hostname
            weight: 5
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - p2pLinkManager-worker
              topologyKey: kubernetes.io/hostname
            weight: 6
      containers:
      - name: "corda-p2p-link-manager-worker"
        image: "corda-os-docker-dev.software.r3.com/corda-os-p2p-link-manager-worker:latest-local-5.1.0"
        imagePullPolicy:  IfNotPresent
        
        securityContext:
          runAsUser: 10001
          runAsGroup: 10002
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - "ALL"
        resources:
          requests:
          limits:
        env:
          - name: K8S_NODE_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: spec.nodeName
          - name: K8S_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: K8S_POD_UID
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.uid
          - name: K8S_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: JAVA_TOOL_OPTIONS
            value:
              -XX:MaxRAMPercentage=75
          - name: LOG4J_CONFIG_FILE
            value: "/etc/log4j/log4j2.xml"
          - name: CONSOLE_LOG_FORMAT
            value: "text"
          - name: CONSOLE_LOG_LEVEL
            value: "info"
          - name: SASL_USERNAME
            value: admin
          - name: SASL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: "prereqs-kafka"
                key: "admin-password"
          - name: SALT
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "salt"
          - name: PASSPHRASE
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "passphrase"
        args:
          - "--workspace-dir=/work"
          - "--temp-dir=/tmp"
          - "-mbootstrap.servers=prereqs-kafka:9092"
          - "-msasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"$(SASL_USERNAME)\" password=\"$(SASL_PASSWORD)\";"
          - "--topic-prefix="
          - "-msecurity.protocol=SASL_SSL"
          - "-msasl.mechanism=PLAIN"
          - "-mssl.truststore.location=/certs/ca.crt"
          - "-mssl.truststore.type=PEM"
          - "-spassphrase=$(PASSPHRASE)"
          - "-ssalt=$(SALT)"
          - "--trace-samples-per-second=1"
        volumeMounts:
          - mountPath: "/tmp"
            name: "tmp"
            readOnly: false
          - mountPath: "/work"
            name: "work"
            readOnly: false
          - mountPath: "/certs"
            name: "certs"
            readOnly: true
          - name: log4j
            mountPath: /etc/log4j
        ports:
          - name: monitor
            containerPort: 7000
        readinessProbe:
          httpGet:
            path: /status
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        livenessProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        startupProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 5
          failureThreshold: 20
          timeoutSeconds: 5
      volumes:
        - name: tmp
          emptyDir: {}
        - name: work
          emptyDir: {}
        - name: certs
          secret:
            secretName: "prereqs-kafka"
            items:
              - key: "ca.crt"
                path: "ca.crt"
        - name: log4j
          configMap:
            name: corda-log4j
---
# Source: corda/templates/workers.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "corda-rest-worker"
  labels:
    
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: rest-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      
      app.kubernetes.io/name: corda
      app.kubernetes.io/instance: corda
      app.kubernetes.io/component: rest-worker
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: /metrics
        prometheus.io/port: "7000"
      labels:
        
        app.kubernetes.io/name: corda
        app.kubernetes.io/instance: corda
        app.kubernetes.io/component: rest-worker
    spec:
      securityContext:
        runAsUser: 10001
        runAsGroup: 10002
        fsGroup: 1000
      
            
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - crypto-worker
              topologyKey: kubernetes.io/hostname
            weight: 1
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - db-worker
              topologyKey: kubernetes.io/hostname
            weight: 2
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - flow-worker
              topologyKey: kubernetes.io/hostname
            weight: 3
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - membership-worker
              topologyKey: kubernetes.io/hostname
            weight: 4
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - p2pGateway-worker
              topologyKey: kubernetes.io/hostname
            weight: 5
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - p2pLinkManager-worker
              topologyKey: kubernetes.io/hostname
            weight: 6
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - rest-worker
              topologyKey: kubernetes.io/hostname
            weight: 7
      containers:
      - name: "corda-rest-worker"
        image: "corda-os-docker-dev.software.r3.com/corda-os-rest-worker:latest-local-5.1.0"
        imagePullPolicy:  IfNotPresent
        
        securityContext:
          runAsUser: 10001
          runAsGroup: 10002
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - "ALL"
        resources:
          requests:
          limits:
        env:
          - name: K8S_NODE_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: spec.nodeName
          - name: K8S_POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: K8S_POD_UID
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.uid
          - name: K8S_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: JAVA_TOOL_OPTIONS
            value:
              -XX:MaxRAMPercentage=75
          - name: LOG4J_CONFIG_FILE
            value: "/etc/log4j/log4j2.xml"
          - name: CONSOLE_LOG_FORMAT
            value: "text"
          - name: CONSOLE_LOG_LEVEL
            value: "info"
          - name: SASL_USERNAME
            value: admin
          - name: SASL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: "prereqs-kafka"
                key: "admin-password"
          - name: SALT
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "salt"
          - name: PASSPHRASE
            valueFrom:
              secretKeyRef:
                name: "corda-config"
                key: "passphrase"
        args:
          - "--workspace-dir=/work"
          - "--temp-dir=/tmp"
          - "-mbootstrap.servers=prereqs-kafka:9092"
          - "-msasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"$(SASL_USERNAME)\" password=\"$(SASL_PASSWORD)\";"
          - "--topic-prefix="
          - "-msecurity.protocol=SASL_SSL"
          - "-msasl.mechanism=PLAIN"
          - "-mssl.truststore.location=/certs/ca.crt"
          - "-mssl.truststore.type=PEM"
          - "-spassphrase=$(PASSPHRASE)"
          - "-ssalt=$(SALT)"
          - "--trace-samples-per-second=1"
          - "-rtls.crt.path=/tls/tls.crt"
          - "-rtls.key.path=/tls/tls.key"
          - "-rtls.ca.crt.path=/tls/ca.crt"
        volumeMounts:
          - mountPath: "/tmp"
            name: "tmp"
            readOnly: false
          - mountPath: "/work"
            name: "work"
            readOnly: false
          - mountPath: "/certs"
            name: "certs"
            readOnly: true
          - mountPath: "/tls"
            name: "tlsmount"
            readOnly: true
          - name: log4j
            mountPath: /etc/log4j
        ports:
          - name: http
            containerPort: 8888
          - name: monitor
            containerPort: 7000
        readinessProbe:
          httpGet:
            path: /status
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        livenessProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 5
        startupProbe:
          httpGet:
            path: /isHealthy
            port: monitor
          periodSeconds: 5
          failureThreshold: 20
          timeoutSeconds: 5
      volumes:
        - name: tmp
          emptyDir: {}
        - name: work
          emptyDir: {}
        - name: certs
          secret:
            secretName: "prereqs-kafka"
            items:
              - key: "ca.crt"
                path: "ca.crt"
        - name: tlsmount
          secret:
            secretName: "corda-rest-tls"
            items:
              - key: "tls.crt"
                path: "tls.crt"
              - key: "tls.key"
                path: "tls.key"
              - key: "ca.crt"
                path: "ca.crt"
        - name: log4j
          configMap:
            name: corda-log4j
---
# Source: corda/templates/bootstrap.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-4"
  name: corda-preinstall-service-account
---
# Source: corda/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: corda-bootstrap-cluster-db
  annotations:
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook": pre-install   
    "helm.sh/hook-delete-policy": hook-succeeded
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  username: "cG9zdGdyZXM="
---
# Source: corda/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: corda-cluster-db
  annotations:
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook": pre-install
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  username: "Y29yZGE="
---
# Source: corda/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: corda-config
  annotations:
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook": pre-install
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  passphrase: "UjZXUERYcks1NHoxZFdFbXBJTGlEZGtPVFhqWUNtdVk="
  salt: "bHpZYVQ0V2trbHlRNFZROTV4SVljV2g2QmhLOGJaeUg="
---
# Source: corda/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: corda-crypto-db
  annotations:
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook": pre-install   
    "helm.sh/hook-delete-policy": hook-succeeded
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  password: "Y0dSYnk3WkRyalBj"
  username: "Y3J5cHRvX3VzZXI="
---
# Source: corda/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: corda-rbac-db
  annotations:
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook": pre-install   
    "helm.sh/hook-delete-policy": hook-succeeded
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  password: "NGVUTlBFMEhGWHVi"
  username: "cmJhY191c2Vy"
---
# Source: corda/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: corda-rest-api-admin
  annotations:
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook": pre-install
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  password: "YWRtaW4="
  username: "YWRtaW4="
---
# Source: corda/templates/config-maps.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: corda-log4j
  annotations:
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook": pre-install
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
data:
  log4j2.xml: | 
    <?xml version="1.0" encoding="UTF-8"?>
    <Configuration status="INFO">
        <Appenders>
            <Console name="json" target="SYSTEM_OUT">
                <JsonTemplateLayout eventTemplateUri="classpath:JsonLayout.json"/>
            </Console>
            <Console name="text" target="SYSTEM_OUT">
                <PatternLayout pattern="%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} %X - %msg%n"/>
            </Console>
        </Appenders>
        <Loggers>
            <logger name="Console">
                <AppenderRef ref="${env:CONSOLE_LOG_FORMAT:-json}" level="info"/>
            </logger>
    
            <!-- log warn only for these 3rd party libs -->
            <Logger name="com.zaxxer.hikari" level="warn" />
            <Logger name="io.javalin.Javalin" level="warn" />
            <Logger name="org.apache.aries.spifly" level="warn" />
            <Logger name="org.apache.kafka" level="warn" />
            <Logger name="org.eclipse.jetty" level="warn" />
            <Logger name="org.hibernate" level="warn" />
            <Logger name="org.pf4j" level="warn" />
    
            <!-- default to warn only for OSGi logging -->
            <Logger name="net.corda.osgi.framework.OSGiFrameworkWrap" level="warn" />
    
            <root level="${env:CONSOLE_LOG_LEVEL:-info}">
                <AppenderRef ref="${env:CONSOLE_LOG_FORMAT:-json}" level="${env:CONSOLE_LOG_LEVEL:-info}"/>
            </root>
        </Loggers>
    </Configuration>
---
# Source: corda/templates/bootstrap.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-3"
  name: corda-preinstall-role
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "watch", "list"]
---
# Source: corda/templates/bootstrap.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-2"
  name: corda-preinstall-role-binding
subjects:
- kind: ServiceAccount
  name: corda-preinstall-service-account
roleRef:
  kind: Role
  name: corda-preinstall-role
  apiGroup: rbac.authorization.k8s.io
---
# Source: corda/templates/bootstrap.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: corda-preinstall-checks
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-1"
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: corda
        app.kubernetes.io/instance: corda
    spec:
      
      
      serviceAccountName: corda-preinstall-service-account
      securityContext:
        runAsUser: 10001
        runAsGroup: 10002
        fsGroup: 1000
      containers:
        - name: preinstall-checks
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          
          resources:
            requests:
            limits:
          args: ['preinstall', 'run-all', '/tmp/values.yaml']
          volumeMounts:
            - mountPath: /tmp
              name: temp
            
            - name: log4j
              mountPath: /etc/log4j
          env:
            
            - name: JAVA_TOOL_OPTIONS
              value: "-Dlog4j2.configurationFile=/etc/log4j/log4j2.xml"
            - name: CONSOLE_LOG_FORMAT
              value: text
            - name: CONSOLE_LOG_LEVEL
              value: info
            - name: CORDA_CLI_HOME_DIR
              value: "/tmp"
      initContainers:
        - name: create-preinstall-values
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          command:
            - /bin/bash
            - -c
          args:
            - |
                echo -e "affinity:\n  podAntiAffinity:\n    preferredDuringSchedulingIgnoredDuringExecution:\n    - podAffinityTerm:\n        labelSelector:\n          matchExpressions:\n          - key: app.kubernetes.io/component\n            operator: In\n            values:\n            - crypto-worker\n        topologyKey: kubernetes.io/hostname\n      weight: 1\n    - podAffinityTerm:\n        labelSelector:\n          matchExpressions:\n          - key: app.kubernetes.io/component\n            operator: In\n            values:\n            - db-worker\n        topologyKey: kubernetes.io/hostname\n      weight: 2\n    - podAffinityTerm:\n        labelSelector:\n          matchExpressions:\n          - key: app.kubernetes.io/component\n            operator: In\n            values:\n            - flow-worker\n        topologyKey: kubernetes.io/hostname\n      weight: 3\n    - podAffinityTerm:\n        labelSelector:\n          matchExpressions:\n          - key: app.kubernetes.io/component\n            operator: In\n            values:\n            - membership-worker\n        topologyKey: kubernetes.io/hostname\n      weight: 4\n    - podAffinityTerm:\n        labelSelector:\n          matchExpressions:\n          - key: app.kubernetes.io/component\n            operator: In\n            values:\n            - p2pGateway-worker\n        topologyKey: kubernetes.io/hostname\n      weight: 5\n    - podAffinityTerm:\n        labelSelector:\n          matchExpressions:\n          - key: app.kubernetes.io/component\n            operator: In\n            values:\n            - p2pLinkManager-worker\n        topologyKey: kubernetes.io/hostname\n      weight: 6\n    - podAffinityTerm:\n        labelSelector:\n          matchExpressions:\n          - key: app.kubernetes.io/component\n            operator: In\n            values:\n            - rest-worker\n        topologyKey: kubernetes.io/hostname\n      weight: 7\nannotations: {}\nbootstrap:\n  db:\n    clientImage:\n      registry: \"\"\n      repository: postgres\n      tag: \"14.4\"\n    cluster:\n      password:\n        value: \"\"\n        valueFrom:\n          secretKeyRef:\n            key: postgres-password\n            name: prereqs-postgres\n      username:\n        value: postgres\n        valueFrom:\n          secretKeyRef:\n            key: \"\"\n            name: \"\"\n    crypto:\n      dbConnectionPool:\n        idleTimeoutSeconds: 120\n        keepaliveTimeSeconds: 0\n        maxLifetimeSeconds: 1800\n        maxSize: 5\n        minSize: null\n        validationTimeoutSeconds: 5\n      password:\n        value: \"\"\n        valueFrom:\n          secretKeyRef:\n            key: \"\"\n            name: \"\"\n      schema: CRYPTO\n      username:\n        value: crypto_user\n        valueFrom:\n          secretKeyRef:\n            key: \"\"\n            name: \"\"\n    enabled: true\n    rbac:\n      dbConnectionPool:\n        idleTimeoutSeconds: 120\n        keepaliveTimeSeconds: 0\n        maxLifetimeSeconds: 1800\n        maxSize: 5\n        minSize: null\n        validationTimeoutSeconds: 5\n      password:\n        value: \"\"\n        valueFrom:\n          secretKeyRef:\n            key: \"\"\n            name: \"\"\n      schema: RBAC\n      username:\n        value: rbac_user\n        valueFrom:\n          secretKeyRef:\n            key: \"\"\n            name: \"\"\n  image:\n    registry: \"\"\n    repository: corda-os-plugins\n    tag: \"\"\n  kafka:\n    cleanup: false\n    enabled: true\n    partitions: 10\n    replicas: 1\n    sasl:\n      password:\n        value: \"\"\n        valueFrom:\n          secretKeyRef:\n            key: \"\"\n            name: \"\"\n      username:\n        value: \"\"\n        valueFrom:\n          secretKeyRef:\n            key: \"\"\n            name: \"\"\n  nodeSelector: {}\n  preinstallCheck:\n    enabled: true\n  rbac:\n    enabled: true\n  resources:\n    limits: {}\n    requests: {}\n  restApiAdmin:\n    password:\n      value: admin\n      valueFrom:\n        secretKeyRef:\n          key: \"\"\n          name: \"\"\n    username:\n      value: admin\n      valueFrom:\n        secretKeyRef:\n          key: \"\"\n          name: \"\"\n  serviceAccount:\n    name: \"\"\ncommonLabels: {}\nconfig:\n  encryption:\n    passphrase:\n      value: \"\"\n      valueFrom:\n        secretKeyRef:\n          key: \"\"\n          name: \"\"\n    salt:\n      value: \"\"\n      valueFrom:\n        secretKeyRef:\n          key: \"\"\n          name: \"\"\ncorda-lib:\n  global: {}\ndb:\n  cluster:\n    database: cordacluster\n    host: prereqs-postgres\n    password:\n      value: \"\"\n      valueFrom:\n        secretKeyRef:\n          key: corda-password\n          name: prereqs-postgres\n    port: 5432\n    schema: CONFIG\n    type: postgresql\n    username:\n      value: corda\n      valueFrom:\n        secretKeyRef:\n          key: \"\"\n          name: \"\"\ndumpHostPath: \"\"\nfullnameOverride: \"\"\nheapDumpOnOutOfMemoryError: false\nimage:\n  registry: corda-os-docker-dev.software.r3.com\n  tag: latest-local-5.1.0\nimagePullPolicy: IfNotPresent\nimagePullSecrets: []\nkafka:\n  bootstrapServers: prereqs-kafka:9092\n  sasl:\n    enabled: true\n    mechanism: PLAIN\n    password:\n      value: \"\"\n      valueFrom:\n        secretKeyRef:\n          key: admin-password\n          name: prereqs-kafka\n    username:\n      value: admin\n      valueFrom:\n        secretKeyRef:\n          key: \"\"\n          name: \"\"\n  tls:\n    enabled: true\n    truststore:\n      password:\n        value: \"\"\n        valueFrom:\n          secretKeyRef:\n            key: \"\"\n            name: \"\"\n      type: PEM\n      valueFrom:\n        secretKeyRef:\n          key: ca.crt\n          name: prereqs-kafka\n  topicPrefix: \"\"\nlogging:\n  format: text\n  level: info\nmetrics:\n  podMonitor:\n    enabled: false\n    labels: {}\n  scrape: true\nnameOverride: \"\"\nnodeSelector: {}\nresources:\n  limits: {}\n  requests: {}\nserviceAccount:\n  name: \"\"\ntolerations: []\ntopologySpreadConstraints: []\ntracing:\n  endpoint: \"\"\n  samplesPerSecond: \"1\"\nworkers:\n  crypto:\n    annotations: {}\n    clusterDbConnectionPool:\n      idleTimeoutSeconds: 120\n      keepaliveTimeSeconds: 0\n      maxLifetimeSeconds: 1800\n      maxSize: 5\n      minSize: null\n      validationTimeoutSeconds: 5\n    debug:\n      enabled: false\n      suspend: false\n    image:\n      registry: \"\"\n      repository: corda-os-crypto-worker\n      tag: \"\"\n    javaOptions: -XX:MaxRAMPercentage=75\n    kafka:\n      sasl:\n        password:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n        username:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n    logging:\n      level: null\n      override: \"\"\n    profiling:\n      enabled: false\n    replicaCount: 1\n    resources:\n      limits: {}\n      requests: {}\n  db:\n    annotations: {}\n    clusterDbConnectionPool:\n      idleTimeoutSeconds: 120\n      keepaliveTimeSeconds: 0\n      maxLifetimeSeconds: 1800\n      maxSize: 5\n      minSize: null\n      validationTimeoutSeconds: 5\n    debug:\n      enabled: false\n      suspend: false\n    image:\n      registry: \"\"\n      repository: corda-os-db-worker\n      tag: \"\"\n    javaOptions: -XX:MaxRAMPercentage=75\n    kafka:\n      sasl:\n        password:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n        username:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n    logging:\n      level: null\n      override: \"\"\n    profiling:\n      enabled: false\n    replicaCount: 1\n    resources:\n      limits: {}\n      requests: {}\n  flow:\n    annotations: {}\n    debug:\n      enabled: false\n      suspend: false\n    image:\n      registry: \"\"\n      repository: corda-os-flow-worker\n      tag: \"\"\n    javaOptions: -XX:MaxRAMPercentage=75\n    kafka:\n      sasl:\n        password:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n        username:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n    logging:\n      level: null\n      override: \"\"\n    profiling:\n      enabled: false\n    replicaCount: 1\n    resources:\n      limits: {}\n      requests: {}\n    verifyInstrumentation: false\n  membership:\n    annotations: {}\n    debug:\n      enabled: false\n      suspend: false\n    image:\n      registry: \"\"\n      repository: corda-os-member-worker\n      tag: \"\"\n    javaOptions: -XX:MaxRAMPercentage=75\n    kafka:\n      sasl:\n        password:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n        username:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n    logging:\n      level: null\n      override: \"\"\n    profiling:\n      enabled: false\n    replicaCount: 1\n    resources:\n      limits: {}\n      requests: {}\n  p2pGateway:\n    annotations: {}\n    debug:\n      enabled: false\n      suspend: false\n    image:\n      registry: \"\"\n      repository: corda-os-p2p-gateway-worker\n      tag: \"\"\n    javaOptions: -XX:MaxRAMPercentage=75\n    kafka:\n      sasl:\n        password:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n        username:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n    logging:\n      level: null\n      override: \"\"\n    profiling:\n      enabled: false\n    replicaCount: 1\n    resources:\n      limits: {}\n      requests: {}\n    service:\n      port: 8080\n  p2pLinkManager:\n    annotations: {}\n    debug:\n      enabled: false\n      suspend: false\n    image:\n      registry: \"\"\n      repository: corda-os-p2p-link-manager-worker\n      tag: \"\"\n    javaOptions: -XX:MaxRAMPercentage=75\n    kafka:\n      sasl:\n        password:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n        username:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n    logging:\n      level: null\n      override: \"\"\n    profiling:\n      enabled: false\n    replicaCount: 1\n    resources:\n      limits: {}\n      requests: {}\n  rest:\n    annotations: {}\n    debug:\n      enabled: false\n      suspend: false\n    image:\n      registry: \"\"\n      repository: corda-os-rest-worker\n      tag: \"\"\n    ingress:\n      annotations: {}\n      className: \"\"\n      hosts: []\n    javaOptions: -XX:MaxRAMPercentage=75\n    kafka:\n      sasl:\n        password:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n        username:\n          value: \"\"\n          valueFrom:\n            secretKeyRef:\n              key: \"\"\n              name: \"\"\n    logging:\n      level: null\n      override: \"\"\n    profiling:\n      enabled: false\n    replicaCount: 1\n    resources:\n      limits: {}\n      requests: {}\n    service:\n      annotations: {}\n      externalTrafficPolicy: \"\"\n      loadBalancerSourceRanges: []\n      port: 443\n      type: ClusterIP\n    tls:\n      ca:\n        secretKey: ca.crt\n      crt:\n        secretKey: tls.crt\n      generation:\n        altNames: []\n      key:\n        secretKey: tls.key\n      secretName: \"\"" > /tmp/values.yaml
          volumeMounts:
            - mountPath: /tmp
              name: temp
      volumes:
        - name: temp
          emptyDir: {}
        
        - name: log4j
          configMap:
            name: corda-log4j
      restartPolicy: Never
      
  backoffLimit: 0
---
# Source: corda/templates/bootstrap.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: corda-setup-db
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": pre-install
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: corda
        app.kubernetes.io/instance: corda
    spec:
      
      
      
      securityContext:
        runAsUser: 10001
        runAsGroup: 10002
        fsGroup: 1000
      containers:
        - name: fin
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          command:
            - /bin/bash
            - -e
            - -c
          args: ["echo", "'DB Bootstrapped'"]
          workingDir: /tmp
          volumeMounts:
            - mountPath: /tmp
              name: temp
      initContainers:
        - name: 01-create-db
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          args: [ 'database', 'spec', '-g', 'config:CONFIG,rbac:RBAC,crypto:CRYPTO', '-c', '-l', '/tmp', '--jdbc-url', 'jdbc:postgresql://prereqs-postgres:5432/cordacluster', '-u', $(PGUSER), '-p', $(PGPASSWORD) ]
          workingDir: /tmp
          volumeMounts:
            - mountPath: /tmp
              name: temp
            
            - name: log4j
              mountPath: /etc/log4j
          env:
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: "corda-bootstrap-cluster-db"
                  key: "username"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: "prereqs-postgres"
                  key: "postgres-password"
            
            - name: JAVA_TOOL_OPTIONS
              value: "-Dlog4j2.configurationFile=/etc/log4j/log4j2.xml"
            - name: CONSOLE_LOG_FORMAT
              value: text
            - name: CONSOLE_LOG_LEVEL
              value: info
            - name: CORDA_CLI_HOME_DIR
              value: "/tmp"
        - name: 02-apply-db
          image: "postgres:14.4"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          command: [ 'sh', '-c', '-e', 'for f in /tmp/*.sql; do psql -v ON_ERROR_STOP=1 -h prereqs-postgres -p 5432 -f "$f" --dbname cordacluster; done' ]
          volumeMounts:
            - mountPath: /tmp
              name: temp
          env:
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: "corda-bootstrap-cluster-db"
                  key: "username"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: "prereqs-postgres"
                  key: "postgres-password"
        - name: 03-create-rbac
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          args: [ 'initial-config', 'create-db-config', '-u', '$(RBAC_DB_USER_USERNAME)', '-p', '$(RBAC_DB_USER_PASSWORD)', '--name', 'corda-rbac', '--jdbc-url', 'jdbc:postgresql://prereqs-postgres:5432/cordacluster?currentSchema=RBAC', '--jdbc-pool-max-size', "5", '--idle-timeout', "120", '--max-lifetime', "1800", '--keepalive-time', "0", '--validation-timeout', "5", '--salt', "$(SALT)", '--passphrase', "$(PASSPHRASE)", '-l', '/tmp']
          workingDir: /tmp
          volumeMounts:
            - mountPath: /tmp
              name: temp
            
            - name: log4j
              mountPath: /etc/log4j
          env:
            
            - name: SALT
              valueFrom:
                secretKeyRef:
                  name: "corda-config"
                  key: "salt"
            - name: PASSPHRASE
              valueFrom:
                secretKeyRef:
                  name: "corda-config"
                  key: "passphrase"
            
            - name: JAVA_TOOL_OPTIONS
              value: "-Dlog4j2.configurationFile=/etc/log4j/log4j2.xml"
            - name: CONSOLE_LOG_FORMAT
              value: text
            - name: CONSOLE_LOG_LEVEL
              value: info
            - name: CORDA_CLI_HOME_DIR
              value: "/tmp"
            
            - name: RBAC_DB_USER_USERNAME
              valueFrom:
                secretKeyRef:
                  name: "corda-rbac-db"
                  key: "username"
            - name: RBAC_DB_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "corda-rbac-db"
                  key: "password"
        - name: 04-apply-rbac
          image: "postgres:14.4"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          command: [ 'sh', '-c', '-e', 'psql -v ON_ERROR_STOP=1 -h prereqs-postgres -p 5432 -f /tmp/db-config.sql --dbname "dbname=cordacluster options=--search_path=CONFIG"' ]
          volumeMounts:
            - mountPath: /tmp
              name: temp
          env:
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: "corda-bootstrap-cluster-db"
                  key: "username"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: "prereqs-postgres"
                  key: "postgres-password"
        - name: 05-create-vnodes
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          args: [ 'initial-config', 'create-db-config', '-a','-u', '$(DB_CLUSTER_USERNAME)', '-p', '$(DB_CLUSTER_PASSWORD)', '--name', 'corda-virtual-nodes', '--jdbc-url', 'jdbc:postgresql://prereqs-postgres:5432/cordacluster', '--jdbc-pool-max-size', "5", '--idle-timeout', "120", '--max-lifetime', "1800", '--keepalive-time', "0", '--validation-timeout', "5", '--salt', "$(SALT)", '--passphrase', "$(PASSPHRASE)", '-l', '/tmp']
          workingDir: /tmp
          volumeMounts:
            - mountPath: /tmp
              name: temp
            
            - name: log4j
              mountPath: /etc/log4j
          env:
            
            - name: SALT
              valueFrom:
                secretKeyRef:
                  name: "corda-config"
                  key: "salt"
            - name: PASSPHRASE
              valueFrom:
                secretKeyRef:
                  name: "corda-config"
                  key: "passphrase"
            
            - name: JAVA_TOOL_OPTIONS
              value: "-Dlog4j2.configurationFile=/etc/log4j/log4j2.xml"
            - name: CONSOLE_LOG_FORMAT
              value: text
            - name: CONSOLE_LOG_LEVEL
              value: info
            - name: CORDA_CLI_HOME_DIR
              value: "/tmp"
            
            - name: RBAC_DB_USER_USERNAME
              valueFrom:
                secretKeyRef:
                  name: "corda-rbac-db"
                  key: "username"
            - name: RBAC_DB_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "corda-rbac-db"
                  key: "password"
            - name: DB_CLUSTER_USERNAME
              valueFrom:
                secretKeyRef:
                  name: "corda-cluster-db"
                  key: "username"
            - name: DB_CLUSTER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "prereqs-postgres"
                  key: "corda-password"
        - name: 06-apply-vnodes
          image: "postgres:14.4"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          command: [ 'sh', '-c', '-e', 'psql -v ON_ERROR_STOP=1 -h prereqs-postgres -p 5432 -f /tmp/db-config.sql --dbname "dbname=cordacluster options=--search_path=CONFIG"' ]
          volumeMounts:
            - mountPath: /tmp
              name: temp
          env:
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: "corda-bootstrap-cluster-db"
                  key: "username"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: "prereqs-postgres"
                  key: "postgres-password"
        - name: 07-create-crypto
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          args: [ 'initial-config', 'create-db-config', '-u', '$(CRYPTO_DB_USER_USERNAME)', '-p', '$(CRYPTO_DB_USER_PASSWORD)', '--name', 'corda-crypto', '--jdbc-url', 'jdbc:postgresql://prereqs-postgres:5432/cordacluster?currentSchema=CRYPTO', '--jdbc-pool-max-size', "5", '--idle-timeout', "120", '--max-lifetime', "1800", '--keepalive-time', "0", '--validation-timeout', "5", '--salt', "$(SALT)", '--passphrase', "$(PASSPHRASE)", '-l', '/tmp']
          workingDir: /tmp
          volumeMounts:
            - mountPath: /tmp
              name: temp
            
            - name: log4j
              mountPath: /etc/log4j
          env:
            
            - name: SALT
              valueFrom:
                secretKeyRef:
                  name: "corda-config"
                  key: "salt"
            - name: PASSPHRASE
              valueFrom:
                secretKeyRef:
                  name: "corda-config"
                  key: "passphrase"
            
            - name: JAVA_TOOL_OPTIONS
              value: "-Dlog4j2.configurationFile=/etc/log4j/log4j2.xml"
            - name: CONSOLE_LOG_FORMAT
              value: text
            - name: CONSOLE_LOG_LEVEL
              value: info
            - name: CORDA_CLI_HOME_DIR
              value: "/tmp"
            - name: CRYPTO_DB_USER_USERNAME
              valueFrom:
                secretKeyRef:
                  name: "corda-crypto-db"
                  key: "username"
            - name: CRYPTO_DB_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "corda-crypto-db"
                  key: "password"
        - name: 08-apply-crypto
          image: "postgres:14.4"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          command: [ 'sh', '-c', '-e', 'psql -v ON_ERROR_STOP=1 -h prereqs-postgres -p 5432 -f /tmp/db-config.sql --dbname "dbname=cordacluster options=--search_path=CONFIG"' ]
          volumeMounts:
            - mountPath: /tmp
              name: temp
          env:
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: "corda-bootstrap-cluster-db"
                  key: "username"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: "prereqs-postgres"
                  key: "postgres-password"
        - name: 09-create-rest
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          args: [ 'initial-config', 'create-user-config', '-u', '$(REST_API_ADMIN_USERNAME)', '-p', '$(REST_API_ADMIN_PASSWORD)', '-l', '/tmp']
          workingDir: /tmp
          volumeMounts:
            - mountPath: /tmp
              name: temp
            
            - name: log4j
              mountPath: /etc/log4j
          env:
            
            - name: JAVA_TOOL_OPTIONS
              value: "-Dlog4j2.configurationFile=/etc/log4j/log4j2.xml"
            - name: CONSOLE_LOG_FORMAT
              value: text
            - name: CONSOLE_LOG_LEVEL
              value: info
            - name: CORDA_CLI_HOME_DIR
              value: "/tmp"
            - name: REST_API_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: corda-rest-api-admin
                  key: username
            - name: REST_API_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: corda-rest-api-admin
                  key: password
        - name: 10-apply-rest
          image: "postgres:14.4"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          command: [ 'sh', '-c', '-e', 'psql -v ON_ERROR_STOP=1 -h prereqs-postgres -p 5432 -f /tmp/rbac-config.sql --dbname "dbname=cordacluster options=--search_path=RBAC"' ]
          volumeMounts:
            - mountPath: /tmp
              name: temp
          env:
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: "corda-bootstrap-cluster-db"
                  key: "username"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: "prereqs-postgres"
                  key: "postgres-password"
        - name: 11-create-db-users-and-grant
          image: "postgres:14.4"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          command: [ '/bin/bash', '-e', '-c' ]
          args:
            - |
              psql -v ON_ERROR_STOP=1 -h prereqs-postgres -p 5432 cordacluster << SQL
                GRANT USAGE ON SCHEMA CONFIG TO "$DB_CLUSTER_USERNAME";
                GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA CONFIG TO "$DB_CLUSTER_USERNAME";
                GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA CONFIG TO "$DB_CLUSTER_USERNAME";
                DO \$\$ BEGIN IF EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '$RBAC_DB_USER_USERNAME') THEN RAISE NOTICE 'Role "$RBAC_DB_USER_USERNAME" already exists'; ELSE CREATE USER "$RBAC_DB_USER_USERNAME" WITH ENCRYPTED PASSWORD '$RBAC_DB_USER_PASSWORD'; END IF; END \$\$;
                GRANT USAGE ON SCHEMA RBAC TO "$RBAC_DB_USER_USERNAME";
                GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA RBAC TO "$RBAC_DB_USER_USERNAME";
                DO \$\$ BEGIN IF EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '$CRYPTO_DB_USER_USERNAME') THEN RAISE NOTICE 'Role "$CRYPTO_DB_USER_USERNAME" already exists'; ELSE CREATE USER "$CRYPTO_DB_USER_USERNAME" WITH ENCRYPTED PASSWORD '$CRYPTO_DB_USER_PASSWORD'; END IF; END \$\$;
                GRANT USAGE ON SCHEMA CRYPTO TO "$CRYPTO_DB_USER_USERNAME";
                GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA CRYPTO TO "$CRYPTO_DB_USER_USERNAME";
              SQL
          volumeMounts:
            - mountPath: /tmp
              name: temp
          env:
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: "corda-bootstrap-cluster-db"
                  key: "username"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: "prereqs-postgres"
                  key: "postgres-password"
          
            - name: RBAC_DB_USER_USERNAME
              valueFrom:
                secretKeyRef:
                  name: "corda-rbac-db"
                  key: "username"
            - name: RBAC_DB_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "corda-rbac-db"
                  key: "password"
          
            - name: CRYPTO_DB_USER_USERNAME
              valueFrom:
                secretKeyRef:
                  name: "corda-crypto-db"
                  key: "username"
            - name: CRYPTO_DB_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "corda-crypto-db"
                  key: "password"
            - name: DB_CLUSTER_USERNAME
              valueFrom:
                secretKeyRef:
                  name: "corda-cluster-db"
                  key: "username"
            - name: DB_CLUSTER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "prereqs-postgres"
                  key: "corda-password"
        - name: 12-create-crypto-config
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          args: [ 'initial-config', 'create-crypto-config', '--salt', "$(SALT)", '--passphrase', "$(PASSPHRASE)", '-l', '/tmp']
          workingDir: /tmp
          volumeMounts:
            - mountPath: /tmp
              name: temp
            
            - name: log4j
              mountPath: /etc/log4j
          env:
            - name: SALT
              valueFrom:
                secretKeyRef:
                  name: "corda-config"
                  key: "salt"
            - name: PASSPHRASE
              valueFrom:
                secretKeyRef:
                  name: "corda-config"
                  key: "passphrase"
            - name: JAVA_TOOL_OPTIONS
              value: "-Dlog4j2.configurationFile=/etc/log4j/log4j2.xml"
            - name: CONSOLE_LOG_FORMAT
              value: text
            - name: CONSOLE_LOG_LEVEL
              value: info
            - name: CORDA_CLI_HOME_DIR
              value: "/tmp"
        - name: 13-apply-crypto-config
          image: "postgres:14.4"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          command: [ 'sh', '-c', '-e', 'psql -v ON_ERROR_STOP=1 -h prereqs-postgres -p 5432 -f /tmp/crypto-config.sql --dbname "dbname=cordacluster options=--search_path=CONFIG"' ]
          volumeMounts:
            - mountPath: /tmp
              name: temp
          env:
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: "corda-bootstrap-cluster-db"
                  key: "username"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: "prereqs-postgres"
                  key: "postgres-password"
      volumes:
        - name: temp
          emptyDir: {}
        
        - name: log4j
          configMap:
            name: corda-log4j
      

      restartPolicy: Never
  backoffLimit: 0
---
# Source: corda/templates/bootstrap.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: corda-create-topics
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": pre-install
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: corda
        app.kubernetes.io/instance: corda
    spec:
      
      
      
      securityContext:
        runAsUser: 10001
        runAsGroup: 10002
        fsGroup: 1000
      containers:
        - name: create-topics
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          
          resources:
            requests:
            limits:
          args: [
            'topic',
            '-b', 'prereqs-kafka:9092',
            '-k', '/tmp/config.properties',
            'create',
            '-u', 'crypto=$(KAFKA_SASL_USERNAME_CRYPTO)',
            '-u', 'db=$(KAFKA_SASL_USERNAME_DB)',
            '-u', 'flow=$(KAFKA_SASL_USERNAME_FLOW)',
            '-u', 'membership=$(KAFKA_SASL_USERNAME_MEMBERSHIP)',
            '-u', 'p2pGateway=$(KAFKA_SASL_USERNAME_P2P_GATEWAY)',
            '-u', 'p2pLinkManager=$(KAFKA_SASL_USERNAME_P2P_LINK_MANAGER)',
            '-u', 'rest=$(KAFKA_SASL_USERNAME_REST)',
            '-r', '1',
            '-p', '10',
            'connect'
          ]
          volumeMounts:
            - mountPath: /tmp
              name: temp
            - mountPath: "/certs"
              name: certs
              readOnly: true
            
            - name: log4j
              mountPath: /etc/log4j
          env:
            
            - name: JAVA_TOOL_OPTIONS
              value: "-Dlog4j2.configurationFile=/etc/log4j/log4j2.xml"
            - name: CONSOLE_LOG_FORMAT
              value: text
            - name: CONSOLE_LOG_LEVEL
              value: info
            - name: CORDA_CLI_HOME_DIR
              value: "/tmp"
            - name: "KAFKA_SASL_USERNAME_CRYPTO"
              value: "admin"
            - name: "KAFKA_SASL_USERNAME_DB"
              value: "admin"
            - name: "KAFKA_SASL_USERNAME_FLOW"
              value: "admin"
            - name: "KAFKA_SASL_USERNAME_MEMBERSHIP"
              value: "admin"
            - name: "KAFKA_SASL_USERNAME_P2P_GATEWAY"
              value: "admin"
            - name: "KAFKA_SASL_USERNAME_P2P_LINK_MANAGER"
              value: "admin"
            - name: "KAFKA_SASL_USERNAME_REST"
              value: "admin"
      initContainers:
        - name: create-trust-store
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          env:
            
            - name: SASL_USERNAME
              value: admin
            - name: SASL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "prereqs-kafka"
                  key: "admin-password"
            
          command:
            - /bin/bash
            - -c
          args:
            - |
                touch /tmp/config.properties
                echo "security.protocol=SASL_SSL\n" >> /tmp/config.properties
                echo "sasl.mechanism=PLAIN\n" >> /tmp/config.properties
                echo "sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=\"$SASL_USERNAME\" password=\"$SASL_PASSWORD\" ;\n">> /tmp/config.properties
                echo "ssl.truststore.location=/certs/ca.crt\n" >> /tmp/config.properties
                echo "ssl.truststore.type=PEM\n" >> /tmp/config.properties
          volumeMounts:
            - mountPath: /tmp
              name: temp
      volumes:
        - name: temp
          emptyDir: {}
        - name: certs
          secret:
            secretName: "prereqs-kafka"
            items:
              - key: "ca.crt"
                path: ca.crt
        
        - name: log4j
          configMap:
            name: corda-log4j
      restartPolicy: Never
      
  backoffLimit: 0
---
# Source: corda/templates/bootstrap.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: corda-setup-rbac
  labels:
    helm.sh/chart: corda-5.1.0
    app.kubernetes.io/name: corda
    app.kubernetes.io/instance: corda
    app.kubernetes.io/version: "unstable-5.1.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": post-install
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: corda
        app.kubernetes.io/instance: corda
    spec:
      
      
      
      securityContext:
        runAsUser: 10001
        runAsGroup: 10002
        fsGroup: 1000
      containers:
        - name: create-rbac-role-user-admin
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          args: ['initial-rbac', 'user-admin', '--yield', '300', '--user', "$(REST_API_ADMIN_USERNAME)",
            '--password', "$(REST_API_ADMIN_PASSWORD)",
            '--target', "https://corda-rest-worker:443", '--insecure']
          volumeMounts:
            - mountPath: /tmp
              name: temp
            
            - name: log4j
              mountPath: /etc/log4j
          env:
            
            - name: REST_API_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: corda-rest-api-admin
                  key: username
            - name: REST_API_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: corda-rest-api-admin
                  key: password
            
            - name: JAVA_TOOL_OPTIONS
              value: "-Dlog4j2.configurationFile=/etc/log4j/log4j2.xml"
            - name: CONSOLE_LOG_FORMAT
              value: text
            - name: CONSOLE_LOG_LEVEL
              value: info
            - name: CORDA_CLI_HOME_DIR
              value: "/tmp"
        - name: create-rbac-role-vnode-creator
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          args: ['initial-rbac', 'vnode-creator', '--yield', '300', '--user', "$(REST_API_ADMIN_USERNAME)",
            '--password', "$(REST_API_ADMIN_PASSWORD)",
            '--target', "https://corda-rest-worker:443", '--insecure']
          volumeMounts:
            - mountPath: /tmp
              name: temp
            
            - name: log4j
              mountPath: /etc/log4j
          env:
            
            - name: REST_API_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: corda-rest-api-admin
                  key: username
            - name: REST_API_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: corda-rest-api-admin
                  key: password
            
            - name: JAVA_TOOL_OPTIONS
              value: "-Dlog4j2.configurationFile=/etc/log4j/log4j2.xml"
            - name: CONSOLE_LOG_FORMAT
              value: text
            - name: CONSOLE_LOG_LEVEL
              value: info
            - name: CORDA_CLI_HOME_DIR
              value: "/tmp"
        - name: create-rbac-role-corda-dev
          image: "corda-os-docker-dev.software.r3.com/corda-os-plugins:latest-local-5.1.0"
          imagePullPolicy: IfNotPresent
          
          resources:
            requests:
            limits:
          
          securityContext:
            runAsUser: 10001
            runAsGroup: 10002
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
          args: ['initial-rbac', 'corda-developer', '--yield', '300', '--user', "$(REST_API_ADMIN_USERNAME)",
            '--password', "$(REST_API_ADMIN_PASSWORD)",
            '--target', "https://corda-rest-worker:443", '--insecure']
          volumeMounts:
            - mountPath: /tmp
              name: temp
            
            - name: log4j
              mountPath: /etc/log4j
          env:
            
            - name: REST_API_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: corda-rest-api-admin
                  key: username
            - name: REST_API_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: corda-rest-api-admin
                  key: password
            
            - name: JAVA_TOOL_OPTIONS
              value: "-Dlog4j2.configurationFile=/etc/log4j/log4j2.xml"
            - name: CONSOLE_LOG_FORMAT
              value: text
            - name: CONSOLE_LOG_LEVEL
              value: info
            - name: CORDA_CLI_HOME_DIR
              value: "/tmp"
      
      volumes:
        - name: temp
          emptyDir: {}
        
        - name: log4j
          configMap:
            name: corda-log4j
      restartPolicy: Never
  backoffLimit: 0
